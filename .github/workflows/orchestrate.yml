name: Orchestrate Full Deployment

on:
  workflow_dispatch:
    inputs:
      target_env:
        type: choice
        description: Environment to deploy
        options: [dev, test, prod]
        required: true

  pull_request:
    branches:
      - main
      - int-agentic

  push:
    branches:
      - tjs-infra-as-code

permissions:
  contents: read
  id-token: write


jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Full orchestrated run through. Should add unit testing and validation here later."

  build-backend-container:
    needs: preflight
    uses: ./.github/workflows/docker-fastapi.yml
    with:
      environment: ${{ inputs.target_env || (github.ref_name == 'tjs-test-infra' && 'dev') || (github.ref_name == 'int-agentic' && 'integration') || (github.ref_name == 'main' && 'prod') || 'dev' }}
    secrets: inherit

  build-mcp-container:
    needs: preflight
    uses: ./.github/workflows/docker-mcp.yml
    with:
      environment: ${{ inputs.target_env || (github.ref_name == 'tjs-test-infra' && 'dev') || (github.ref_name == 'int-agentic' && 'integration') || (github.ref_name == 'main' && 'prod') || 'dev' }}
    secrets: inherit

  deploy-infrastructure:
    needs: [ build-backend-container, build-mcp-container ]
    uses: ./.github/workflows/infrastructure.yml
    with:
      environment: ${{ inputs.target_env || (github.ref_name == 'tjs-test-infra' && 'dev') || (github.ref_name == 'int-agentic' && 'integration') || (github.ref_name == 'main' && 'prod') || 'dev' }}
    secrets: inherit

  destroy-infrastructure:
    needs: [ deploy-infrastructure ]
    if: always() && (github.event_name == 'workflow_dispatch' && github.event.inputs.iac-tool || 'tf') == 'tf' && (github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.base_ref == 'main' && 'prod') || (github.base_ref == 'int-agentic' && 'integration') || 'dev') == 'dev' && needs.tf.result == 'success' && needs.test_prep.result == 'success'
    uses: ./.github/workflows/destroy.yml
    with:
      environment: ${{ inputs.target_env || (github.ref_name == 'tjs-test-infra' && 'dev') || (github.ref_name == 'int-agentic' && 'integration') || (github.ref_name == 'main' && 'prod') || 'dev' }}
    secrets: inherit